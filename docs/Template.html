<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0">
  <link href=../src/css/initial.css rel=stylesheet type="text/css">
  <link href=../src/css/reset.css rel=stylesheet type="text/css">
  <link href=../src/css/colors.css rel=stylesheet type="text/css">
  <link href=../src/css/fonts.css rel=stylesheet type="text/css">
  <link href=../src/css/variables.css rel=stylesheet type="text/css">
  <script async rel=preload as="script" type="text/javascript" src="../src/es/helpers/Environment.js"></script>
  <!-- wc-config.js gets loaded once the template fetched its body path -->
  <!--<script async rel=preload as="script" type="text/javascript" src="../wc-config.js"></script>-->
  <title>Web Components Toolbox ðŸ˜Ž</title>
</head>
<body>
  <p-general>
    <o-header menu-icon="true" namespace="header-default-" namespace-fallback role="header">
      <!-- template path passed by path query gets loaded into here. eg. ./src/es/components/molecules/navigation/default-/default-.html -->
    </o-header>
    <o-body>
      <!-- template path passed by path query gets loaded into here. eg. ./src/es/components/pages/Template.html?path=../molecules/teaser/tile-/tile-.html -->
    </o-body>
    <!-- template path passed by path query gets loaded into here. eg. ./src/es/components/organisms/footer/default-/default-.html -->
  </p-general>
</body>
<script>
  const loadWcConfig = () => {
    const script = document.createElement('script')
    script.setAttribute('src', location.href.replace(/((src)|(docs))\/.*/, 'wc-config.js?triggerImmediately=true'))
    document.head.appendChild(script)
  }
  const loadHTML = (path, selector, append = false, rootFolder) => {
    if (!path) return null
    if (!rootFolder) rootFolder = 'docs'
    path = location.href.replace(new RegExp(`${rootFolder}\/.*`), path)
    return fetch(path).then(res => res.text()).then(innerHTML => {
      // fix relative links
      innerHTML = innerHTML.replace(/([^\.])\.\/([^\.])/g, `$1${path.replace(/(.*\/)(.*)$/, '$1')}$2`)
      if (append) {
        const div = document.createElement('div')
        div.innerHTML = innerHTML
        Array.from(div.childNodes).forEach(node => {
          if (node) document.querySelector(selector).appendChild(node)
        })
      } else {
        document.querySelector(selector).innerHTML = innerHTML
      }
      // fetched html scripts don't execute automatically, create new script tags and append them to head
      Array.from(document.querySelectorAll('.template-script')).forEach(script => {
        const newScript = document.createElement('script')
        newScript.setAttribute('src', script.getAttribute('src'))
        document.head.appendChild(newScript)
        script.remove()
      })
    })
  }
  const loadCSS = (path, rootFolder) => {
    if (!path) return null
    if (!rootFolder) rootFolder = 'docs'
    const link = document.createElement('link')
    link.setAttribute('href', location.href.replace(new RegExp(`${rootFolder}\/.*`), path))
    link.setAttribute('rel', 'stylesheet')
    link.setAttribute('type', 'text/css')
    document.head.appendChild(link)
    return Promise.resolve()
  }
  const url =  new URL(location.href)
  Promise.all([
    loadCSS(url.searchParams.get('css'), url.searchParams.get('rootFolder')),
    loadHTML(url.searchParams.get('logo'), 'o-header', true, url.searchParams.get('rootFolder')),
    loadHTML(url.searchParams.get('nav'), 'o-header', true, url.searchParams.get('rootFolder')),
    loadHTML(url.searchParams.get('content'), 'o-body', undefined, url.searchParams.get('rootFolder')),
    loadHTML(url.searchParams.get('footer'), 'p-general', true, url.searchParams.get('rootFolder'))
  ]).then(() => loadWcConfig())
</script>
</html>